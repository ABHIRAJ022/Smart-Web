{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="mb-3">
    <a href="{% url 'dashboard_home' %}" class="btn btn-sm btn-secondary">&larr; Back to Dashboard</a>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h2>Vitals for {{ patient.username|title }}</h2>
        <p class="text-muted" id="dashboard-subtitle">Live IoT Health Data & History</p>
    </div>
    <div class="col-md-4">
        <div class="card {% if 'Risk' in prediction %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
            <div class="card-body text-center">
                <h5 class="card-title">AI Prediction Status</h5>
                <p class="card-text fw-bold">{{ prediction|default:"Waiting for Sensor Data..." }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-secondary">
            <div class="card-header bg-secondary text-white">
                <h6 class="m-0 font-weight-bold">Filter Historical Data by Date and Time</h6>
            </div>
            <div class="card-body bg-light">
                <form method="GET" class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label for="start_time" class="col-form-label fw-bold">From:</label>
                    </div>
                    <div class="col-auto">
                        <input type="datetime-local" id="start_time" name="start_time" class="form-control" value="{{ request.GET.start_time }}">
                    </div>
                    
                    <div class="col-auto">
                        <label for="end_time" class="col-form-label fw-bold">To:</label>
                    </div>
                    <div class="col-auto">
                        <input type="datetime-local" id="end_time" name="end_time" class="form-control" value="{{ request.GET.end_time }}">
                    </div>
                    
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">Fetch History</button>
                        <a href="{% url 'view_patient_vitals' patient.id %}" class="btn btn-outline-secondary">Clear Filter & Return to Live Data</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if request.GET.start_time %}
    <div class="alert alert-info">
        <strong>Viewing Historical Data.</strong> Live auto-refresh is paused. The single values below represent the newest reading found in your selected timeframe.
    </div>
{% endif %}

<div class="row text-center">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">Body Temp (°C)</div>
            <div class="card-body"><h3 class="fw-bold">{{ iot_data.field1|default:"--" }}</h3></div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">Smoke / Gas Level</div>
            <div class="card-body"><h3 class="fw-bold">{{ iot_data.field2|default:"--" }}</h3></div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">Alcohol Level</div>
            <div class="card-body"><h3 class="fw-bold">{{ iot_data.field3|default:"--" }}</h3></div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">Fall Detection (Distance)</div>
            <div class="card-body"><h3 class="fw-bold">{{ iot_data.field4|default:"--" }}</h3></div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">Room Humidity</div>
            <div class="card-body"><h3 class="fw-bold">{{ iot_data.field5|default:"--" }}</h3></div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">Room Temp (°C)</div>
            <div class="card-body"><h3 class="fw-bold">{{ iot_data.field6|default:"--" }}</h3></div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-12 mb-4">
        <div class="card shadow-sm border-dark">
            <div class="card-header bg-dark text-white font-weight-bold">
                Master View: All Vitals Combined
            </div>
            <div class="card-body">
                <canvas id="masterChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-white font-weight-bold text-primary">
                Body Temperature Trend
            </div>
            <div class="card-body">
                <canvas id="bodyTempChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm border-success">
            <div class="card-header bg-white font-weight-bold text-success">
                Room Environment (Temp & Humidity)
            </div>
            <div class="card-body">
                <canvas id="roomEnvChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm border-warning">
            <div class="card-header bg-white font-weight-bold text-warning">
                Air Quality Levels (Smoke & Alcohol)
            </div>
            <div class="card-body">
                <canvas id="airQualityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm border-info">
            <div class="card-header bg-white font-weight-bold text-info">
                Fall Detection (Distance)
            </div>
            <div class="card-body">
                <canvas id="fallChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white font-weight-bold">
                Raw Sensor Data Log
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0 text-center" id="dataTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Timestamp</th>
                                <th>Body Temp (°C)</th>
                                <th>Smoke Level</th>
                                <th>Alcohol Level</th>
                                <th>Fall Dist.</th>
                                <th>Room Humidity (%)</th>
                                <th>Room Temp (°C)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const isFiltering = window.location.search.includes("start_time");

    if (!isFiltering) {
        const refreshInterval = 15000;
        setTimeout(function() { window.location.reload(); }, refreshInterval);
    }

    document.addEventListener("DOMContentLoaded", function() {
        const timeString = new Date().toLocaleTimeString();
        const subtitle = document.getElementById("dashboard-subtitle");
        if(subtitle) {
            if (isFiltering) {
                subtitle.innerHTML = `Viewing Historical Data <span class="badge bg-info ms-2">Auto-refresh paused</span>`;
            } else {
                subtitle.innerHTML = `Live IoT Health Data Dashboard <span class="badge bg-secondary ms-2">Last updated: ${timeString}</span>`;
            }
        }

        // Setup Chart.js Logic
        const rawChartData = '{{ chart_data|escapejs }}';
        
        if (rawChartData && rawChartData !== '[]') {
            const feeds = JSON.parse(rawChartData);
            
            // Extract Timestamps for X-Axis
            const labels = feeds.map(feed => {
                const date = new Date(feed.created_at);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            });
            
            // Extract All 6 Fields of Data
            const bodyTempData = feeds.map(feed => parseFloat(feed.field1 || 0));
            const smokeData = feeds.map(feed => parseFloat(feed.field2 || 0));
            const alcoholData = feeds.map(feed => parseFloat(feed.field3 || 0));
            const fallData = feeds.map(feed => parseFloat(feed.field4 || 0));
            const roomHumidData = feeds.map(feed => parseFloat(feed.field5 || 0));
            const roomTempData = feeds.map(feed => parseFloat(feed.field6 || 0));

            // Populate the Numerical Data Table
            const tbody = document.getElementById('tableBody');
            // We reverse the feeds so the newest data appears at the top of the table
            [...feeds].reverse().forEach(feed => {
                const date = new Date(feed.created_at);
                const timeStr = date.toLocaleString();
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${parseFloat(feed.field1 || 0).toFixed(1)}</td>
                    <td>${parseFloat(feed.field2 || 0).toFixed(1)}</td>
                    <td>${parseFloat(feed.field3 || 0).toFixed(1)}</td>
                    <td>${parseFloat(feed.field4 || 0).toFixed(1)}</td>
                    <td>${parseFloat(feed.field5 || 0).toFixed(1)}</td>
                    <td>${parseFloat(feed.field6 || 0).toFixed(1)}</td>
                `;
                tbody.appendChild(tr);
            });

            // ==========================================
            // CHART 0: MASTER CHART (All Data)
            // ==========================================
            new Chart(document.getElementById('masterChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Body Temp', data: bodyTempData, borderColor: '#0d6efd', backgroundColor: '#0d6efd', yAxisID: 'y', tension: 0.3, pointRadius: 2 },
                        { label: 'Room Temp', data: roomTempData, borderColor: '#198754', backgroundColor: '#198754', yAxisID: 'y', tension: 0.3, pointRadius: 2 },
                        { label: 'Humidity', data: roomHumidData, borderColor: '#212529', backgroundColor: '#212529', yAxisID: 'y1', borderDash: [5, 5], tension: 0.3, pointRadius: 2 },
                        { label: 'Smoke', data: smokeData, borderColor: '#dc3545', backgroundColor: '#dc3545', yAxisID: 'y1', tension: 0.3, pointRadius: 2 },
                        { label: 'Alcohol', data: alcoholData, borderColor: '#ffc107', backgroundColor: '#ffc107', yAxisID: 'y1', tension: 0.3, pointRadius: 2 },
                        { label: 'Fall Dist.', data: fallData, type: 'bar', backgroundColor: 'rgba(13, 202, 240, 0.4)', borderColor: '#0dcaf0', borderWidth: 1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Temperature (°C)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Levels / Distance / %' },
                            grid: { drawOnChartArea: false } // Prevent gridlines from overlapping
                        }
                    }
                }
            });

            // Chart 1: Body Temperature
            new Chart(document.getElementById('bodyTempChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Body Temp (°C)',
                        data: bodyTempData,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2, tension: 0.3, fill: true
                    }]
                }
            });

            // Chart 2: Room Environment
            new Chart(document.getElementById('roomEnvChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Room Temp (°C)', data: roomTempData, borderColor: '#198754', borderWidth: 2, tension: 0.3 },
                        { label: 'Humidity (%)', data: roomHumidData, borderColor: '#212529', borderWidth: 2, borderDash: [5, 5], tension: 0.3 }
                    ]
                }
            });

            // Chart 3: Air Quality (Smoke & Alcohol)
            new Chart(document.getElementById('airQualityChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Smoke/Gas Level', data: smokeData, borderColor: '#dc3545', borderWidth: 2, tension: 0.3 },
                        { label: 'Alcohol Level', data: alcoholData, borderColor: '#ffc107', borderWidth: 2, tension: 0.3 } 
                    ]
                }
            });

            // Chart 4: Fall Detection
            new Chart(document.getElementById('fallChart').getContext('2d'), {
                type: 'bar', // Bar chart for visual spikes
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Distance/Movement',
                        data: fallData,
                        backgroundColor: '#0dcaf0', 
                        borderWidth: 1
                    }]
                }
            });
        }
    });
</script>
{% endblock %}