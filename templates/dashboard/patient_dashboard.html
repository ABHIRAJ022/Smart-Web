{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .fade-in-up { animation: slideUpFade 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @keyframes slideUpFade { to { opacity: 1; transform: translateY(0); } }

    .glass-card {
        background: #ffffff;
        border-radius: 1.25rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.04);
        transition: all 0.3s ease;
        overflow: hidden;
        border: 1px solid #f1f5f9;
        height: 100%;
    }

    .section-title {
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 1.5rem;
        padding-left: 10px;
        border-left: 4px solid #3b82f6; /* Added explicit color for primary */
    }

    .chart-container-main { height: 400px; position: relative; }
    .chart-container-small { height: 200px; position: relative; }
    
    .table-responsive { border-radius: 1rem; }
</style>

<div class="container-fluid fade-in-up">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <h2 class="fw-bold text-dark m-0">Diagnostic Dashboard: {{ patient.username|title }}</h2>
        <button id="exportPdf" class="btn btn-dark btn-sm px-4 py-2" style="border-radius: 0.75rem;">
            <i class="fas fa-file-pdf me-2 text-danger"></i> Export Report
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card glass-card p-3">
                <p class="text-muted small fw-bold mb-1">Fall Dist.</p>
                <h4 class="fw-bold m-0" style="color: #f59e0b;">{{ iot_data.field4|default:"--" }}cm</h4>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card glass-card p-3">
                <p class="text-muted small fw-bold mb-1">Humidity</p>
                <h4 class="fw-bold m-0 text-primary">{{ iot_data.field5|default:"--" }}%</h4>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card glass-card p-3">
                <p class="text-muted small fw-bold mb-1">Room Temp</p>
                <h4 class="fw-bold m-0 text-success">{{ iot_data.field6|default:"--" }}°C</h4>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card glass-card p-3">
                <p class="text-muted small fw-bold mb-1">Smoke/Gas</p>
                <h4 class="fw-bold m-0 text-secondary">{{ iot_data.field2|default:"--" }}</h4>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card glass-card p-3">
                <p class="text-muted small fw-bold mb-1">Alcohol</p>
                <h4 class="fw-bold m-0" style="color: #a21caf;">{{ iot_data.field3|default:"--" }}</h4>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card glass-card p-3">
                <p class="text-muted small fw-bold mb-1">Rain</p>
                <h4 class="fw-bold m-0 text-info">{{ iot_data.field7|default:"--" }}</h4>
            </div>
        </div>
    </div>

    <h5 class="section-title">Global Sensor Correlation Trends</h5>
    <div class="row mb-5">
        <div class="col-12">
            <div class="card glass-card p-4">
                <div class="chart-container-main">
                    <canvas id="mainTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <h5 class="section-title">Individual Metric Analysis</h5>
    <div class="row mb-5">
        <div class="col-md-4 mb-4">
            <div class="card glass-card p-3">
                <h6 class="fw-bold small text-muted mb-3">Fall Distance (cm)</h6>
                <div class="chart-container-small"><canvas id="chartFall"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card glass-card p-3">
                <h6 class="fw-bold small text-muted mb-3">Humidity (%)</h6>
                <div class="chart-container-small"><canvas id="chartHumid"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card glass-card p-3">
                <h6 class="fw-bold small text-muted mb-3">Room Temp (°C)</h6>
                <div class="chart-container-small"><canvas id="chartTemp"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card glass-card p-3">
                <h6 class="fw-bold small text-muted mb-3">Smoke & Gas Level</h6>
                <div class="chart-container-small"><canvas id="chartSmoke"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card glass-card p-3">
                <h6 class="fw-bold small text-muted mb-3">Alcohol Level</h6>
                <div class="chart-container-small"><canvas id="chartAlcohol"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card glass-card p-3">
                <h6 class="fw-bold small text-muted mb-3">Rain Presence</h6>
                <div class="chart-container-small"><canvas id="chartRain"></canvas></div>
            </div>
        </div>
    </div>

    <h5 class="section-title">Full Diagnostic Logs</h5>
    <div class="row mb-5">
        <div class="col-12">
            <div class="card glass-card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center" id="vitalsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Fall (cm)</th>
                                <th>Humid (%)</th>
                                <th>Room (°C)</th>
                                <th>Smoke</th>
                                <th>Alcohol</th>
                                <th>Rain</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const rawDataStr = '{{ chart_data|escapejs }}';
        if (!rawDataStr || rawDataStr === '[]') return;
        
        const feeds = JSON.parse(rawDataStr);
        const labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        
        const dataSet = {
            fall: feeds.map(f => parseFloat(f.field4) || 0),
            humid: feeds.map(f => parseFloat(f.field5) || 0),
            temp: feeds.map(f => parseFloat(f.field6) || 0),
            smoke: feeds.map(f => parseFloat(f.field2) || 0),
            alcohol: feeds.map(f => parseFloat(f.field3) || 0),
            rain: feeds.map(f => parseFloat(f.field7) || 0)
        };

        const tbody = document.getElementById('tableBody');
        [...feeds].reverse().forEach((f) => {
            tbody.innerHTML += `
                <tr>
                    <td class="small text-muted">${new Date(f.created_at).toLocaleString()}</td>
                    <td>${f.field4 || '--'}</td>
                    <td>${f.field5 || '--'}</td>
                    <td>${f.field6 || '--'}</td>
                    <td>${f.field2 || '--'}</td>
                    <td>${f.field3 || '--'}</td>
                    <td>${f.field7 || '--'}</td>
                </tr>`;
        });

        // Charts Logic
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
        };

        const initSmallChart = (id, label, data, color) => {
            new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: label, data: data, borderColor: color, backgroundColor: color + '22', fill: true, tension: 0.4, pointRadius: 1 }]
                },
                options: commonOptions
            });
        };

        initSmallChart('chartFall', 'Fall', dataSet.fall, '#f59e0b');
        initSmallChart('chartHumid', 'Humid', dataSet.humid, '#0284c7');
        initSmallChart('chartTemp', 'Temp', dataSet.temp, '#16a34a');
        initSmallChart('chartSmoke', 'Smoke', dataSet.smoke, '#64748b');
        initSmallChart('chartAlcohol', 'Alcohol', dataSet.alcohol, '#a21caf');
        initSmallChart('chartRain', 'Rain', dataSet.rain, '#06b6d4');

        new Chart(document.getElementById('mainTrendChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Fall', data: dataSet.fall, borderColor: '#f59e0b', tension: 0.3 },
                    { label: 'Humid', data: dataSet.humid, borderColor: '#0284c7', tension: 0.3 },
                    { label: 'Temp', data: dataSet.temp, borderColor: '#16a34a', tension: 0.3 },
                    { label: 'Smoke', data: dataSet.smoke, borderColor: '#64748b', tension: 0.3 },
                    { label: 'Alcohol', data: dataSet.alcohol, borderColor: '#a21caf', tension: 0.3 },
                    { label: 'Rain', data: dataSet.rain, borderColor: '#06b6d4', tension: 0.3 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
            }
        });

        // FIXED EXPORT PDF SCRIPT
        document.getElementById('exportPdf').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for more space
            
            // Add Header
            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.text('Diagnostic Patient Report', 14, 22);
            
            // Add Sub-header
            doc.setFontSize(12);
            doc.setTextColor(100);
            const date = new Date().toLocaleString();
            doc.text(`Patient: {{ patient.username|title }}`, 14, 32);
            doc.text(`Generated on: ${date}`, 14, 38);

            // Generate Table using autoTable plugin
            doc.autoTable({
                html: '#vitalsTable',
                startY: 45,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] }, // Primary color
                styles: { fontSize: 9, halign: 'center' },
                columnStyles: { 0: { halign: 'left' } }
            });

            doc.save(`Report_{{ patient.username }}_${new Date().getTime()}.pdf`);
        });
    });
</script>
{% endblock %}